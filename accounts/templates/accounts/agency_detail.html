{# accounts/templates/accounts/agency_detail.html #}
{% extends 'accounts/base.html' %}
{% load static %}

{% block extra_css %}
    <style>
        /* Collapsible Sidebar Styles */
        .sidebar {
            width: 250px; /* Normal width */
            transition: width 0.3s;
            overflow-x: hidden; /* Hide horizontal scrollbar */
        }

        .sidebar.collapsed {
            width: 70px; /* Collapsed width */
        }

        .sidebar .nav-link {
            padding: 0.75rem 1rem;
        }

        .sidebar.collapsed .nav-link span {
            display: none; /* Hide text in collapsed mode */
        }

        .sidebar.collapsed .nav-link {
            padding: 0.75rem 0.5rem; /* Adjust padding in collapsed mode */
            text-align: center; /* Center icons */
        }

        /* Active Link Style */
        .nav-link.active {
            background-color: #007bff; /* Bootstrap primary color */
            color: white;
            font-weight: bold;
        }

        /* Hide toggle button text on smaller screens */
        @media (max-width: 768px) {
            #sidebarToggle span {
                display: none;
            }
        }
    </style>
{% endblock %}

{% block content %}
<style>
    /* Collapsible Sidebar Styles */
    .sidebar {
        width: 250px; /* Normal width */
        transition: width 0.3s;
        overflow-x: hidden; /* Hide horizontal scrollbar */
    }

    .sidebar.collapsed {
        width: 70px; /* Collapsed width */
    }

    .sidebar .nav-link {
        padding: 0.75rem 1rem;
    }

    .sidebar.collapsed .nav-link span {
        display: none; /* Hide text in collapsed mode */
    }

    .sidebar.collapsed .nav-link {
        padding: 0.75rem 0.5rem; /* Adjust padding in collapsed mode */
        text-align: center; /* Center icons */
    }

    /* Active Link Style */
    .nav-link.active {
        background-color: #007bff; /* Bootstrap primary color */
        color: white;
        font-weight: bold;
    }

    /* Hide toggle button text on smaller screens */
    @media (max-width: 768px) {
        #sidebarToggle span {
            display: none;
        }
    }
</style>
<div class="container-fluid">
    <div class="row">
  {# Sidebar #}
  <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
    <div class="position-sticky pt-3">
        {% if agency.logo %}
            <img src="{{ agency.logo.url }}" alt="{{ agency.agency_name }} Logo" class="img-fluid rounded-circle mb-3">
        {% else %}
            <p>No logo uploaded</p>
        {% endif %}

        {# Sidebar Toggle Button (Inside Sidebar) #}
        <button id="sidebarToggle" class="btn btn-sm btn-outline-secondary mb-3">
            <i class="fas fa-bars"></i>
        </button>

        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link {% if active_tab == 'agency_statistics' %}active{% endif %}" href="{% url 'accounts:agency_detail' agency.pk %}">
                    <i class="fas fa-chart-bar"></i> <span> Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_tab == 'agency_info' %}active{% endif %}" href="{% url 'accounts:agency_info' agency.pk %}">
                    <i class="fas fa-info-circle"></i> <span>Agency Information</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_tab == 'agency_kyc' %}active{% endif %}" href="{% url 'accounts:agency_kyc' agency.pk %}">
                    <i class="fas fa-file-alt"></i> <span>KYC Documents</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_tab == 'agent_list' %}active{% endif %}" href="{% url 'accounts:agent_list' agency.pk %}">
                    <i class="fas fa-users"></i> <span>Manage Agents</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_tab == 'service_provider_list' %}active{% endif %}" href="{% url 'providers:service_provider_list' agency.pk %}">
                    <i class="fas fa-hand-holding-usd"></i> <span>Manage Service Providers</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_tab == 'notification_list' %}active{% endif %}" href="{% url 'notifications:notification_list' %}">
                    <i class="fas fa-bell"></i> <span>Notifications</span>
                </a>
            </li>
        </ul>
    </div>
</nav>

        {# Main Content #}
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Agency Dashboard</h1>
                <button id="sidebarToggle" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-bars"></i> <span>Toggle Sidebar</span>
                </button>
            </div>

            {# Statistics Cards (Flex Container) #}
            <div class="d-flex flex-wrap justify-content-start mb-3">
                <div class="card text-white bg-primary mb-3 mx-2" style="max-width: 18rem;">
                    <div class="card-header">Payments Today</div>
                    <div class="card-body">
                        <h4 class="card-title">{{ today_payments_count }}</h4>
                    </div>
                </div>

                {% for provider, deposit in provider_deposits.items %}
                <div class="card text-white bg-info mb-3 mx-2" style="max-width: 18rem;">
                    <div class="card-header">Total Deposits - {{ provider }}</div>
                    <div class="card-body">
                        <h4 class="card-title">{{ deposit }}</h4>
                    </div>
                </div>
                {% endfor %}

                {% for provider, withdrawal in provider_withdrawals.items %}
                <div class="card text-white bg-warning mb-3 mx-2" style="max-width: 18rem;">
                    <div class="card-header">Total Withdrawals - {{ provider }}</div>
                    <div class="card-body">
                        <h4 class="card-title">{{ withdrawal }}</h4>
                    </div>
                </div>
                {% endfor %}

                {% for provider, balance in current_balances.items %}
                <div class="card text-white bg-success mb-3 mx-2" style="max-width: 18rem;">
                    <div class="card-header">Current Balance - {{ provider }}</div>
                    <div class="card-body">
                        <h4 class="card-title">{{ balance }}</h4>
                    </div>
                </div>
                {% endfor %}
            </div>

            {# Recent Transactions Table #}
            <h2>Recent Transactions</h2>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Receiver</th>
                        <th>Sender</th>
                        <th>Agent</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for transaction in recent_transactions %}
                        <tr>
                            <td>{{ transaction.date_heure }}</td>
                            <td>{{ transaction.montant }}</td>
                            <td>{{ transaction.type }}</td>
                            <td>{{ transaction.numero_recepteur }}</td>
                            <td>{{ transaction.numero_expediteur }}</td>
                            <td>{{ transaction.agent.account.username }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            {# Top 5 Withdrawals Table #}
            <h2>Top 5 Withdrawals</h2>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                    <tr>
                        <th>Transaction Time</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Receiver</th>
                        <th>Sender</th>
                        <th>Agent</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for transaction in top_5_withdrawals %}
                        <tr>
                            <td>{{ transaction.date_heure }}</td>
                            <td>{{ transaction.montant }}</td>
                            <td>{{ transaction.type }}</td>
                            <td>{{ transaction.numero_recepteur }}</td>
                            <td>{{ transaction.numero_expediteur }}</td>
                            <td>{{ transaction.agent.account.username }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            {# Top 5 Deposits Table #}
            <h2>Top 5 Deposits</h2>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                    <tr>
                        <th>Transaction Time</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Receiver</th>
                        <th>Sender</th>
                        <th>Agent</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for transaction in top_5_deposits %}
                        <tr>
                            <td>{{ transaction.date_heure }}</td>
                            <td>{{ transaction.montant }}</td>
                            <td>{{ transaction.type }}</td>
                            <td>{{ transaction.numero_recepteur }}</td>
                            <td>{{ transaction.numero_expediteur }}</td>
                            <td>{{ transaction.agent.account.username }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <h2>Latest Notifications</h2>
            {% if notifications %}
                <ul class="list-group">
                    {% for notification in notifications %}
                        <li class="list-group-item">
                            {{ notification.message }}
                            <span class="text-muted">({{ notification.timestamp }})</span>
                        </li>
                    {% endfor %}
                </ul>
                <a href="{% url 'notifications:notification_list' %}">View All Notifications</a>
            {% else %}
                <p>No notifications yet.</p>
            {% endif %}

            <div class="row">
                <div class="col-md-6">
                    <h2>Transaction Volume Chart</h2>
                    <canvas id="transactionVolumeChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h2>Deposit and Withdrawals</h2>
                    <canvas id="depositWithdrawalChart" width="400" height="200"></canvas>
                </div>
            </div>
        </main>
    </div>
</div>

{# Charts - place at the end of the body for faster loading #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const transactionVolumeData = {
        labels: [{% for transaction in recent_transactions %} "{{ transaction.date_heure|date:'Y-m-d H:i' }}", {% endfor %}],
        datasets: [{
            label: 'Transaction Volume',
            data: [{% for transaction in recent_transactions %} {{ transaction.montant }}, {% endfor %}],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    };

    // Transaction Volume Chart Configuration
    const transactionVolumeConfig = {
        type: 'line',
        data: transactionVolumeData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    };

    // Render Transaction Volume Chart
    const transactionVolumeChart = new Chart(
        document.getElementById('transactionVolumeChart'),
        transactionVolumeConfig
    );

    // Deposit Withdrawal Chart Data
    const depositWithdrawalData = {
        labels: [{% for provider, deposit in provider_deposits.items %} "{{ provider }}", {% endfor %}],
        datasets: [{
            label: 'Deposits',
            data: [{% for provider, deposit in provider_deposits.items %} {{ deposit }}, {% endfor %}],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }, {
            label: 'Withdrawals',
            data: [{% for provider, withdrawal in provider_withdrawals.items %} {{ withdrawal }}, {% endfor %}],
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
        }]
    };

    // Deposit Withdrawal Chart Configuration
    const depositWithdrawalConfig = {
        type: 'bar',
        data: depositWithdrawalData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    };

    // Render Deposit Withdrawal Chart
    const depositWithdrawalChart = new Chart(
        document.getElementById('depositWithdrawalChart'),
        depositWithdrawalConfig
    );
</script>

<script>
    // Sidebar Toggle Logic
    document.addEventListener('DOMContentLoaded', function () {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');

        sidebarToggle.addEventListener('click', function () {
            sidebar.classList.toggle('collapsed');
        });
    });
</script>
{% endblock %}
